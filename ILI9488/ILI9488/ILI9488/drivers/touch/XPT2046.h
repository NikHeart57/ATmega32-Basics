/**
 * @note        Комментарий сгенерирован нейросетью deepseek 19.08.25
 *
 * @file        XPT2046.h
 * @brief       Драйвер тач-контроллера XPT2046 для AVR ATmega32
 * @details     Предоставляет полный набор функций для работы с резистивным тач-экраном
 *              через интерфейс SPI с поддержкой прерываний и калибровки.
 * 
 * @note        Особенности:
 *              - Полная интеграция с системой прерываний MCU
 *              - Медианная фильтрация и усреднение данных (16 samples)
 *              - Калибровка координат с коэффициентами масштаба и смещения
 *              - Автоматическая настройка SPI и прерываний
 *              - Проверка валидности касания по аппаратным пределам
 * 
 * @warning     Ограничения:
 *              - Требует предварительной настройки SPI драйвера
 *              - Калибровочные коэффициенты индивидуальны для каждого экрана
 *              - Не поддерживает multi-touch и жесты
 * 
 * @attention   Для работы необходимо:
 *              - Подключение пинов CS и IRQ согласно схеме
 *              - Настройка SPI на режим 0, MSB first, 1-2 MHz
 *              - Правильная калибровка для конкретного экрана
 * 
 * @todo        Планируемые улучшения:
 *              - Автоматическая калибровка по 4 точкам
 *              - Адаптивная фильтрация на основе шума
 * 
 * @bug         Известные проблемы:
 *              - 
 * 
 * @author      Николай Куркин, deepseek
 * @date        2025-08-19
 * @version     1.0
 * 
 * @copyright   MIT License
 */
#pragma once

#ifndef F_CPU
#define F_CPU               16000000
#endif

#include <avr/io.h>
#include <util/delay.h>
#include "../mcu/SPI.h"
#include "../mcu/INT.h"
#include "../display/ILI9488.h"

//////////////////////////////////////////////////////////////////////////
//  ?????????? ?????????
//////////////////////////////////////////////////////////////////////////

/**
 * @brief ??? Chip Select ???-???????????
 */
#define XPT2046_CS_DDR		DDRD
#define XPT2046_CS_PORT		PORTD
#define XPT2046_CS_PIN		PD3    ///< Chip Select ??? ???-???????????

/**
 * @brief ??? ?????????? ???-???????????
 */
#define XPT2046_IRQ_DDR		DDRD
#define XPT2046_IRQ_PORT	PORTD
#define XPT2046_IRQ_PINREG	PIND
#define XPT2046_IRQ_PIN		PD2   ///< ??? ?????????? (IRQ)

//////////////////////////////////////////////////////////////////////////
//  ??????? ?????????? XPT2046
//////////////////////////////////////////////////////////////////////////

/**
 * @brief ??????? ??? ?????????? XPT2046
 * @note ???? ???????: START | A2 | A1 | A0 | MODE | SER/DFR | PD1 | PD0
 */
#define XPT2046_CMD_X		0x90  ///< ????????? ?????????? X
#define XPT2046_CMD_Y		0xD0  ///< ????????? ?????????? Y
#define XPT2046_CMD_Z1		0xB0  ///< ????????? Z1 (??? ??????????? ????????)
#define XPT2046_CMD_Z2		0xC0  ///< ????????? Z2 (??? ??????????? ????????)

//////////////////////////////////////////////////////////////////////////
//  ????????????? ???????????? (?? ?????????)
//////////////////////////////////////////////////////////////////////////

/**
 * @brief ???????????? ?????????? ?? ?????????
 * @note ?????? ???? ????????? ??? ??????? ??????????? ??????
 */
#define XPT2046_CALIB_X_SCALE    1.097f		///< ?????????? ??????????? ?? X
#define XPT2046_CALIB_X_OFFSET   -19.6f		///< ???????? ?? X
#define XPT2046_CALIB_Y_SCALE    1.12f		///< ?????????? ??????????? ?? Y
#define XPT2046_CALIB_Y_OFFSET   -21.56f	///< ???????? ?? Y

/**
 * @brief ?????? ?????????? ???????
 * @note ???????? ?? ????????? ???? ??????? ????????? ?????
 */
#define XPT2046_X_MIN     100		///< ??????????? ???????? ???????? X
#define XPT2046_X_MAX     3900		///< ???????????? ???????? ???????? X
#define XPT2046_Y_MIN     100		///< ??????????? ???????? ???????? Y
#define XPT2046_Y_MAX     3900		///< ???????????? ???????? ???????? Y

/**
 * @brief ????????? ??????????
 */
#define XPT2046_SAMPLES   8			///< ?????????? ??????? ??? ??????????
#define XPT2046_DISCARD   2			///< ?????????? ????????????? ??????? ????????

//////////////////////////////////////////////////////////////////////////
//  ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
//////////////////////////////////////////////////////////////////////////

/**
 * @brief Флаг касания (устанавливается в прерывании, сбрасывается в main)
 * @note volatile для корректной работы между прерыванием и main
 */
extern volatile uint8_t xpt2046_touch_flag;

/**
 * @brief Координаты последнего касания (заполняются в прерывании)
 * @note volatile для корректной работы между прерыванием и main
 */
extern volatile uint16_t xpt2046_touch_x;
extern volatile uint16_t xpt2046_touch_y;

/**
 * @brief 
 */
typedef struct {
    float x_scale;   ///< ?????????? ??????????? ?? X
    float x_offset;  ///< ???????? ?? X
    float y_scale;   ///< ?????????? ??????????? ?? Y
    float y_offset;  ///< ???????? ?? Y
} XPT2046_Calibration;

/**

 * @brief ??????? ????????????? ???????????? (???????? ?????)

 */

extern XPT2046_Calibration xpt2046_current_calibration;

//////////////////////////////////////////////////////////////////////////
//  ????????? ???????
//////////////////////////////////////////////////////////////////////////

/**
 * @brief ??????? ????????????? ????? ???-???????????
 * @note ??????????? ?????? ???? CS ? IRQ, ??? ??????????
 */
void XPT2046_Setup(void);

/**
 * @brief ??? ??????? ??? ????????? ??????????
 * @param[in] state ????????? ?????????? (???/????)
 * @param[in] mode ????? ???????? ??????????
 */
typedef void (*XPT2046_IntSetupCallback)(Int_State state, Int_TriggerMode mode);

/**

 * @brief ????????????? ???-??????????? ? ??????????? ? ?????????? ??????????
 * @param[in] calib ????????? ?? ????????? ?????????? (NULL ??? ???????? ?? ?????????)
 * @param[in] int_setup_callback ??????? ????????? ?????????? (NULL ???? ?????????? ?? ?????)
 * @param[in] int_trigger_mode ????? ???????? ?????????? (???? callback ??????)
 * 
 * @example
 * XPT2046_Init(&my_calib, INT0_Init, INT_TRIGGER_FALLING_EDGE);
 */

void XPT2046_Init(XPT2046_Calibration* calib, XPT2046_IntSetupCallback int_setup_callback, Int_TriggerMode int_trigger_mode);

/**
 * @brief ?????? ????? ?????? ? ???-???????????
 * @param[in] command ??????? ????????? (X, Y, Z1, Z2)
 * @return ????? 12-?????? ???????? (0-4095)
 */
uint16_t XPT2046_ReadData(uint8_t command);

/**
 * @brief ?????? ??????????????? ????????? ???????
 * @param[out] x ?????????? X ?? ?????? (0 - SCREEN_WIDTH-1)
 * @param[out] y ?????????? Y ?? ?????? (0 - SCREEN_HEIGHT-1)
 * @return 1 ???? ??????? ???????, 0 ???? ??? ???????
 */
uint8_t XPT2046_ReadCoordinates(volatile uint16_t &x, volatile uint16_t &y);

/**
 * @brief ???????? ??????? ???????
 * @return 1 ???? ???? ???????, 0 ???? ???
 * @note ?????? ????????? ???? IRQ
 */
uint8_t XPT2046_IsTouched(void);

/**
 * @brief ????????? ????????????? ?????????????
 * @param[in] calib ????????? ?? ????????? ??????????
 */

void XPT2046_SetCalibration(XPT2046_Calibration* calib);







/**
 * @brief Чтение значения давления (Z)
 * @return Значение давления (0-4095)
 */
uint16_t XPT2046_ReadPressure(void);

